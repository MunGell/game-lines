function ID(i){return document.getElementById(i)}function Class(i){return document.getElementsByClassName(i)[0]}function getNodesOf(i,t){if(t)var e=t.toHash();for(var s=[],n=i.childNodes,a=0,r=n.length;r>a;a++){var h=n[a];1==h.nodeType&&(!e||e[h.tagName])&&s.push(h)}return s}function getPositionOf(i){for(var t={x:0,y:0},e=i;e;e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function makeVisible(i){i.style.visibility="visible"}function makeHidden(i){i.style.visibility="hidden"}function processEvent(i,t){var e=[].splice.call(arguments,2);return function(s){s=s||window.event,i[t].apply(i,[s].concat(e))}}function stopEvent(i){i=i||window.event,i.cancelBubble=!0}function classNameOf(i){var t=classNameEditor;return t.value=i.className,t.obj=i,t}function Square(i,t){this.x=i,this.y=t;var e=document.createElement("div");e.className="square square-col"+(i+1)+" square-row"+(t+1),this.obj=Class("grid").appendChild(e),this.obj.onclick=processEvent(this,"click"),this.ball=null}function Line(i){this.color=i.ball.color,this.x=i.x,this.y=i.y,this.items=[],this.items.push(i.ball)}function Ball(i,t){this.color=i,this.obj=document.createElement("div"),this.obj.className="ball ball-responsive ball-"+i,this.state=t||0,this.active=this.state<8,this.aim=this.active?7:0}var classNameEditor={seek:function(i){var t=" ",e=t+this.value+t;return e.seek(t=i+t)},add:function(i){this.value.seek(i)||(this.obj.className=this.value+" "+i)},remove:function(i){if(this.value.seek(i)){var t=" ",e=t+this.value+t,s=new RegExp(t+i+t);this.obj.className=e.replace(s,t).trim()}},flip:function(i){var t=this.add(i);this.value==t&&this.remove(i)}};String.prototype.seek=function(i){return this.indexOf(i)>-1},String.prototype.toHash=function(i){for(var t=i||" ",e={},s=this.split(t),n=s.length;n-->0;)e[s[n]]=!0;return e},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},Number.prototype.decline=function(i){var t=this+" ",e=i.split(/- |,/g),s=t.match(/([^1]|^)1 /)?1:t.match(/([^1]|^)[234] /)?2:3;return t+e[0]+e[s]};var linesGrid={checkSquares:[],init:function(){for(this.ready||(this.obj=Class("grid"),this.squares=[]),this.unselect(),x=0;9>x;x++)for(this.ready||(this.squares[x]=[]),y=0;9>y;y++)this.ready?this.squares[x][y].deleteBall():this.squares[x][y]=new Square(x,y);Preview.init(),Score.init(),this.ready&&Cookies.expire("savedgame"),this.ready=!0,this.loadGame()},reset:function(){for(x=0;9>x;x++)for(y=0;9>y;y++){var i=this.squares[x][y];i.step=null,i.from=null}pathfinder.init()},unselect:function(){this.selected&&(classNameOf(this.selected.obj).remove("selected"),this.selected=null)},add:function(){var i=[];for(x=0;9>x;x++)for(y=0;9>y;y++){var t=this.squares[x][y];t.ball||i.push(t)}if(i.length){var e=Math.floor(Math.random()*i.length-0,1);i[e].createBall(Preview.use()),this.checkSquares.push(i[e])}},turn:function(){for(var i=0;3>i;i++)this.add();this.makeTurn=!1,animation.onfinish="linesGrid.checkLines()",animation.start()},checkLines:function(){var i=this.checkSquares.shift();if(i&&i.ball){var t=i.findSame();t.items.length>4?t.fire():this.checkLines()}else this.makeTurn?this.turn():(this.selected&&this.selected.select(),this.saveGame())},saveGame:function(){var i=[];for(x=0;9>x;x++)for(y=0;9>y;y++){var t=this.squares[x][y].ball;if(t){var e=x.toString()+y.toString();i.push(e+t.color)}}if(i.length<81){var s=i.join("-")+"~"+Preview.items.join("-")+"~"+Score.value;Cookies.set("savedgame",s)}else Cookies.expire("savedgame"),alert("Game over")},loadGame:function(){var i=Cookies.get("savedgame");if(i){for(var t=i.split("~"),e=t[0].split("-"),s=0,n=e.length;n>s;s++){var a=e[s],r=parseInt(a.charAt(0)),h=parseInt(a.charAt(1));this.squares[r][h].createBall(a.substr(2))}Preview.items=t[1].split("-"),Preview.update(),Score.value=parseInt(t[2]),Score.obj.innerHTML=Score.value,this.makeTurn=!1,animation.start()}else this.makeTurn=!0,this.turn();highscore.init()}},Preview={colors:["yellow","green","red","blue","violet","aqua","pink"],init:function(){var i=Class("preview");this.nodes=getNodesOf(i),this.items=[];for(var t=0;3>t;t++)this.add();this.update()},add:function(){var i=Math.floor(Math.random()*this.colors.length);this.items.push(this.colors[i])},use:function(){var i=this.items.shift();return this.add(),this.update(),i},update:function(){for(var i=0;3>i;i++)this.nodes[i].className="ball ball-"+this.items[i]}},pathfinder={init:function(){this.items=[],this.size=0},add:function(i){this.size=this.items.push(i)},process:function(){for(var i=0;i<this.size;)this.items[i].findSteps(),i++}};Square.prototype={createBall:function(i,t){this.ball=new Ball(i,t),this.ball.parent=this,this.obj.appendChild(this.ball.obj),animation.items.push(this.ball)},deleteBall:function(){this.ball&&(this.obj.removeChild(this.ball.obj),this.ball=null),this==linesGrid.selected&&linesGrid.unselect()},click:function(){this.ball&&7==this.ball.state&&this.select(),!this.ball&&!animation.disableClick&&linesGrid.selected&&this.step&&this.invite()},select:function(){linesGrid.reset(),this.step=1,pathfinder.add(this),pathfinder.process(),linesGrid.unselect(),linesGrid.selected=this,classNameOf(this.obj).add("selected")},invite:function(){var i=linesGrid.selected.ball;this.createBall(i.color,0-this.step),i.aim=0,animation.items.push(i,this.ball);for(var t=this.from;t.step>1;)t.createBall(i.color,7+t.step),t.ball.aim=0,animation.items.push(t.ball),t=t.from;linesGrid.makeTurn=!0,linesGrid.checkSquares.push(this),linesGrid.unselect(),animation.onfinish="linesGrid.checkLines()",animation.start()},findSteps:function(){this.checkStep(this.x-1,this.y),this.checkStep(this.x+1,this.y),this.checkStep(this.x,this.y-1),this.checkStep(this.x,this.y+1)},checkStep:function(i,t){var e=linesGrid.squares[i];if(!e)return!1;var s=e[t],n=this.step+1;s&&!s.ball&&(!s.step||s.step>n)&&(s.step=n,s.from=this,pathfinder.add(s))},findSame:function(){var i=new Line(this),t=new Line(this);t.addLine(-1,-1),t.addLine(1,1),i.replace(t.items);var e=new Line(this);e.addLine(-1,1),e.addLine(1,-1),i.replace(e.items);var s=new Line(this);s.addLine(0,-1),s.addLine(0,1),i.replace(s.items);var n=new Line(this);n.addLine(-1,0),n.addLine(1,0),i.replace(n.items);var a=!1;n.items.length>2&&(i.replace(this.findCross(-1,0,0)),i.replace(this.findCross(1,0,0)),a=!0),s.items.length>2&&(i.replace(this.findCross(0,-1,0)),i.replace(this.findCross(0,1,0)),a=!0),a&&i.replace(this.findCross(0,0,0));var r=!1;return t.items.length>2&&(i.replace(this.findCross(-1,-1,1)),i.replace(this.findCross(1,1,1)),r=!0),e.items.length>2&&(i.replace(this.findCross(-1,1,1)),i.replace(this.findCross(1,-1,1)),r=!0),r&&i.replace(this.findCross(0,0,1)),i},findCross:function(i,t,e){var s=new Line(this),n=this.x+i,a=this.y+t;return s.items=[],s.add(n,a),s.items.length&&(s.add(n+1,a+e),s.add(n-1,a-e),s.add(n+e,a-1),s.add(n-e,a+1)),s.items}},Line.prototype={addLine:function(i,t){for(var e=1,s=!0;s;e++)s=this.add(this.x+e*i,this.y+e*t)},add:function(i,t){var e=linesGrid.squares[i];if(!e)return!1;var s=e[t];return s&&s.ball&&7==s.ball.state&&s.ball.color==this.color?(this.items.push(s.ball),!0):!1},fire:function(){for(var i=0,t=this.items.length;t>i;i++){var e=this.items[i];e.aim=0,animation.items.push(e)}Score.current+=2*this.items.length,animation.items.push(Score),linesGrid.makeTurn=!1,animation.onfinish="linesGrid.checkLines()",animation.start()},replace:function(i){i.length>this.items.length&&(this.items=i)}},Ball.prototype={show:function(){var i=this.state;i>0&&8>i?(this.active||(i=1),this.obj.style.backgroundPosition="0 "+(i-7)*this.obj.offsetWidth*1.1+"px",this.obj.style.visibility="visible"):this.obj.style.visibility="hidden"},animate:function(){return this.state>this.aim&&this.state--,this.state<this.aim&&this.state++,0==this.state&&0==this.aim?(this.parent.deleteBall(),!1):(this.show(),this.state!=this.aim)}};var Score={init:function(){this.value=0,this.current=0,this.obj=Class("score"),this.obj.innerHTML=this.value},animate:function(){return this.current&&(this.current--,this.value++,this.obj.innerHTML=this.value),this.current||highscore.show(),this.current}},highscore={active:!1,init:function(){this.obj=Class("highscore");var i=Cookies.get("highscore");i&&(this.value=parseInt(i),this.show())},show:function(){this.value?(Score.value<=this.value&&(this.obj.innerHTML=this.value),Score.value>this.value&&(this.obj.innerHTML=Score.value,this.save())):this.save()},save:function(){Cookies.set("highscore",Score.value)}},animation={items:[],active:!1,timer:null,endTimer:null,disableClick:!1,start:function(){clearTimeout(this.endTimer),this.disableClick=!0,this.active||this.apply()},end:function(){clearTimeout(this.endTimer),this.disableClick=!1},apply:function(){clearTimeout(this.timer),this.active=!1;for(var i=0,t=this.items.length;t>i;i++){var e=this.items.shift(0);e.animate()&&this.items.push(e)}this.items.length?(this.active=!0,this.timer=setTimeout("animation.apply()",50)):this.onfinish?(this.endTimer=setTimeout("animation.end()",300),setTimeout(this.onfinish,250),this.onfinish=null):this.end()}};!function(i){i(document).ready(function(){linesGrid.init()}),i(".js-next-turn").click(function(){linesGrid.turn()}),i(".js-new-game").click(function(){linesGrid.init()}),i(".js-toggles").click(function(){i(this).find(".js-toggle").each(function(){i(this).toggleClass("js-hidden")})})}(jQuery,_);